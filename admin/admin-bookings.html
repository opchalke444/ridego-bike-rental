<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Bookings - RideGo Admin</title>
    <meta name="description" content="View and manage all bookings on the RideGo platform.">
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
</head>

<body>

    <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">‚ò∞</button>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="dashboard-wrap">
        <aside class="dashboard-sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="../assets/images/logo.png" alt="RideGo Logo">
                <div class="sidebar-brand">RideGo <small>Admin Panel</small></div>
            </div>
            <nav class="sidebar-nav">
                <a href="admin-dashboard.html"><span class="nav-icon">üìä</span> Dashboard</a>
                <a href="admin-users.html"><span class="nav-icon">üë•</span> Users</a>
                <a href="admin-vendors.html"><span class="nav-icon">üè™</span> Vendors</a>
                <a href="admin-bikes.html"><span class="nav-icon">üèçÔ∏è</span> Bikes</a>
                <a href="admin-bookings.html" class="active"><span class="nav-icon">üìÖ</span> Bookings</a>
                <a href="admin-analytics.html"><span class="nav-icon">üìà</span> Analytics</a>
            </nav>
            <div class="sidebar-footer">
                <a href="#" id="logoutLink"><span class="nav-icon">üö™</span> Logout</a>
            </div>
        </aside>

        <div class="dashboard-main">
            <header class="dashboard-topbar">
                <div class="topbar-title">
                    <h1>Bookings Management</h1>
                    <p>View and manage all platform bookings</p>
                </div>
                <div class="topbar-actions">
                    <div class="topbar-user">
                        <div class="topbar-avatar" id="avatarInitials">A</div>
                        <span id="adminName">Admin</span>
                    </div>
                </div>
            </header>

            <div class="dashboard-content">

                <!-- Stats -->
                <div class="dashboard-cards-grid" style="grid-template-columns:repeat(auto-fit,minmax(160px,1fr));">
                    <div class="dashboard-card card-blue">
                        <div class="card-top">
                            <div>
                                <div class="card-label">Total</div>
                                <div class="card-value" id="totalBookings">0</div>
                            </div>
                            <div class="card-icon">üìÖ</div>
                        </div>
                    </div>
                    <div class="dashboard-card card-green">
                        <div class="card-top">
                            <div>
                                <div class="card-label">Active</div>
                                <div class="card-value" id="activeBookings">0</div>
                            </div>
                            <div class="card-icon">üü¢</div>
                        </div>
                    </div>
                    <div class="dashboard-card card-purple">
                        <div class="card-top">
                            <div>
                                <div class="card-label">Upcoming</div>
                                <div class="card-value" id="upcomingBookings">0</div>
                            </div>
                            <div class="card-icon">‚è≥</div>
                        </div>
                    </div>
                    <div class="dashboard-card card-amber">
                        <div class="card-top">
                            <div>
                                <div class="card-label">Completed</div>
                                <div class="card-value" id="completedBookings">0</div>
                            </div>
                            <div class="card-icon">‚úÖ</div>
                        </div>
                    </div>
                    <div class="dashboard-card card-green">
                        <div class="card-top">
                            <div>
                                <div class="card-label">Revenue</div>
                                <div class="card-value" id="totalRevenue" style="font-size:1.3rem;">‚Çπ0</div>
                            </div>
                            <div class="card-icon">üí∞</div>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div style="display:flex;gap:1rem;margin-bottom:1.5rem;flex-wrap:wrap;align-items:center;">
                    <select class="form-control" id="statusTab" style="width:auto;min-width:160px;padding:0.6rem 1rem;"
                        onchange="filterBookings()">
                        <option value="all">All Bookings</option>
                        <option value="upcoming">Upcoming</option>
                        <option value="active">Active</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                    <input type="text" class="form-control" id="searchInput" placeholder="üîç Search by ID, user, bike‚Ä¶"
                        style="flex:1;min-width:220px;padding:0.6rem 1rem;" oninput="filterBookings()">
                    <select class="form-control" id="paymentFilter"
                        style="width:auto;min-width:140px;padding:0.6rem 1rem;" onchange="filterBookings()">
                        <option value="all">All Payments</option>
                        <option value="completed">Paid</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>

                <!-- Bookings Table -->
                <div class="dashboard-table-wrap">
                    <div class="table-overflow">
                        <table class="dashboard-table" style="min-width:1000px;">
                            <thead>
                                <tr>
                                    <th>Booking ID</th>
                                    <th>User</th>
                                    <th>Bike</th>
                                    <th>Start</th>
                                    <th>End</th>
                                    <th>Days</th>
                                    <th>Amount</th>
                                    <th>Payment</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="bookingsTableBody">
                                <tr>
                                    <td colspan="10" style="text-align:center;padding:3rem;color:var(--gray);">Loading
                                        bookings‚Ä¶</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Booking Details Modal -->
    <div class="modal-overlay" id="bookingModal">
        <div class="modal-box" style="max-width:800px;">
            <div class="modal-header">
                <h2>Booking Details</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="bookingDetailsContent"></div>
        </div>
    </div>

    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/bookings.js"></script>
    <script>
        if (!AuthService.isAuthenticated()) window.location.href = '../login.html';
        const currentUser = AuthService.getCurrentUser();
        if (currentUser.role !== 'admin') { alert('Access denied.'); window.location.href = '../index.html'; }

        document.getElementById('adminName').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
        document.getElementById('avatarInitials').textContent = ((currentUser.firstName || 'A')[0] + (currentUser.lastName || '')[0]).toUpperCase();

        const sidebar = document.getElementById('sidebar');
        document.getElementById('sidebarToggle').addEventListener('click', () => { sidebar.classList.toggle('open'); document.getElementById('sidebarOverlay').classList.toggle('show'); });
        document.getElementById('sidebarOverlay').addEventListener('click', () => { sidebar.classList.remove('open'); document.getElementById('sidebarOverlay').classList.remove('show'); });

        let allBookings = [];

        function loadBookings() {
            allBookings = JSON.parse(localStorage.getItem('ridego_bookings') || '[]');

            const activeCount = allBookings.filter(b => b.status === 'active').length;
            const upcomingCount = allBookings.filter(b => b.status === 'upcoming').length;
            const completedCount = allBookings.filter(b => b.status === 'completed').length;
            const totalRevenue = allBookings.filter(b => b.paymentStatus === 'completed').reduce((s, b) => s + (b.total || 0), 0);

            document.getElementById('totalBookings').textContent = allBookings.length;
            document.getElementById('activeBookings').textContent = activeCount;
            document.getElementById('upcomingBookings').textContent = upcomingCount;
            document.getElementById('completedBookings').textContent = completedCount;
            document.getElementById('totalRevenue').textContent = '‚Çπ' + totalRevenue.toLocaleString();

            filterBookings();
        }

        function filterBookings() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('statusTab').value;
            const payment = document.getElementById('paymentFilter').value;
            const filtered = allBookings.filter(b => {
                const ms = (b.id + ' ' + b.userName + ' ' + b.bikeName).toLowerCase().includes(search);
                const mst = status === 'all' || b.status === status;
                const mp = payment === 'all' || b.paymentStatus === payment;
                return ms && mst && mp;
            });
            renderBookings(filtered);
        }

        function renderBookings(bookings) {
            const tbody = document.getElementById('bookingsTableBody');
            if (bookings.length === 0) { tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:3rem;color:var(--gray);">No bookings found.</td></tr>'; return; }
            tbody.innerHTML = bookings.map(b => {
                const sc = b.status === 'active' ? 'status-approved' : b.status === 'upcoming' ? 'status-pending' : b.status === 'completed' ? 'status-approved' : 'status-rejected';
                const pc = b.paymentStatus === 'completed' ? 'status-approved' : 'status-pending';
                return `<tr>
                    <td><strong>${b.id}</strong></td>
                    <td><div>${b.userName}</div><div style="color:var(--gray);font-size:0.82rem;">${b.userEmail}</div></td>
                    <td><div>${b.bikeName}</div><div style="color:var(--gray);font-size:0.82rem;">${b.bikeCategory}</div></td>
                    <td>${new Date(b.startDate).toLocaleDateString()}</td>
                    <td>${new Date(b.endDate).toLocaleDateString()}</td>
                    <td>${b.days}</td>
                    <td><strong>‚Çπ${(b.total || 0).toLocaleString()}</strong></td>
                    <td><span class="status-badge ${pc}" style="text-transform:capitalize;">${b.paymentStatus}</span></td>
                    <td><span class="status-badge ${sc}" style="text-transform:capitalize;">${b.status}</span></td>
                    <td><button class="dash-btn dash-btn-edit" onclick="viewBooking('${b.id}')">üëÅÔ∏è View</button></td>
                </tr>`;
            }).join('');
        }

        function viewBooking(bookingId) {
            const b = allBookings.find(x => x.id === bookingId);
            if (!b) return;
            const sc = b.status === 'active' ? 'status-approved' : b.status === 'upcoming' ? 'status-pending' : b.status === 'completed' ? 'status-approved' : 'status-rejected';
            const pc = b.paymentStatus === 'completed' ? 'status-approved' : 'status-pending';

            const detailGrid = (title, items) => `
                <h4 style="margin:1rem 0 0.6rem;color:var(--gray);font-weight:600;">${title}</h4>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                    ${items.map(([l, v]) => `<div style="padding:0.7rem;background:var(--light-gray);border-radius:8px;"><div style="font-size:0.82rem;color:var(--gray);">${l}</div><div style="font-weight:600;color:var(--dark);">${v}</div></div>`).join('')}
                </div>`;

            document.getElementById('bookingDetailsContent').innerHTML =
                detailGrid('Booking', [['Booking ID', b.id], ['Status', `<span class="status-badge ${sc}" style="text-transform:capitalize;">${b.status}</span>`], ['Created', new Date(b.createdAt).toLocaleString()], ['Destination', b.destinationName || b.destination || '‚Äî']]) +
                detailGrid('User', [['Name', b.userName], ['Email', b.userEmail], ['Phone', b.userPhone || '‚Äî'], ['User ID', b.userId]]) +
                detailGrid('Bike', [['Bike', b.bikeName], ['Category', b.bikeCategory], ['Daily Rate', '‚Çπ' + (b.dailyRate || 0).toLocaleString()], ['Bike ID', b.bikeId]]) +
                detailGrid('Rental Period', [['Start', new Date(b.startDate).toLocaleDateString()], ['End', new Date(b.endDate).toLocaleDateString()], ['Pickup', b.pickupTime || '‚Äî'], ['Drop', b.dropTime || '‚Äî'], ['Days', b.days], ['Location', b.pickupLocation || '‚Äî']]) +
                detailGrid('Payment', [['Subtotal', '‚Çπ' + (b.subtotal || 0).toLocaleString()], ['GST (18%)', '‚Çπ' + (b.gst || 0).toLocaleString()], ['Total', '<strong>‚Çπ' + (b.total || 0).toLocaleString() + '</strong>'], ['Payment', `<span class="status-badge ${pc}" style="text-transform:capitalize;">${b.paymentStatus}</span>`], ...(b.paymentMethod ? [['Method', b.paymentMethod.toUpperCase()]] : []), ...(b.paymentId ? [['Payment ID', b.paymentId]] : [])]) +
                detailGrid('Vendor', [['Vendor', b.vendorName || '‚Äî'], ['Contact', b.vendorContact || '‚Äî']]);

            document.getElementById('bookingModal').classList.add('show');
        }

        function closeModal() { document.getElementById('bookingModal').classList.remove('show'); }

        document.getElementById('logoutLink').addEventListener('click', e => { e.preventDefault(); if (confirm('Logout?')) { AuthService.logout(); window.location.href = '../login.html'; } });

        loadBookings();
    </script>
</body>

</html>