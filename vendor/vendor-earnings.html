<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Earnings - RideGo Vendor</title>
    <meta name="description" content="Track your rental earnings on RideGo.">
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
</head>

<body>

    <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">â˜°</button>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="dashboard-wrap">
        <aside class="dashboard-sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="../assets/images/logo.png" alt="RideGo Logo">
                <div class="sidebar-brand">RideGo <small>Vendor Portal</small></div>
            </div>
            <nav class="sidebar-nav">
                <a href="vendor-dashboard.html"><span class="nav-icon">ğŸ“Š</span> Dashboard</a>
                <a href="vendor-bikes.html"><span class="nav-icon">ğŸï¸</span> My Bikes</a>
                <a href="vendor-bookings.html"><span class="nav-icon">ğŸ“…</span> Bookings</a>
                <a href="vendor-earnings.html" class="active"><span class="nav-icon">ğŸ’°</span> Earnings</a>
                <a href="vendor-profile.html"><span class="nav-icon">ğŸ‘¤</span> Profile</a>
            </nav>
            <div class="sidebar-footer">
                <a href="#" id="logoutLink"><span class="nav-icon">ğŸšª</span> Logout</a>
            </div>
        </aside>

        <div class="dashboard-main">
            <header class="dashboard-topbar">
                <div class="topbar-title">
                    <h1>Earnings</h1>
                    <p>Track your revenue from bike rentals</p>
                </div>
                <div class="topbar-actions">
                    <div class="topbar-user">
                        <div class="topbar-avatar" id="avatarInitials">V</div>
                        <span id="vendorName">Vendor</span>
                    </div>
                </div>
            </header>

            <div class="dashboard-content">

                <!-- Summary Cards -->
                <div class="dashboard-cards-grid">
                    <div class="dashboard-card card-green">
                        <div class="card-top">
                            <div>
                                <div class="card-label">Total Earnings</div>
                                <div class="card-value" id="totalEarnings">â‚¹0</div>
                            </div>
                            <div class="card-icon">ğŸ’°</div>
                        </div>
                        <div class="card-sub">Lifetime revenue</div>
                    </div>
                    <div class="dashboard-card card-blue">
                        <div class="card-top">
                            <div>
                                <div class="card-label">This Month</div>
                                <div class="card-value" id="monthEarnings">â‚¹0</div>
                            </div>
                            <div class="card-icon">ğŸ“ˆ</div>
                        </div>
                    </div>
                    <div class="dashboard-card card-amber">
                        <div class="card-top">
                            <div>
                                <div class="card-label">Pending Payouts</div>
                                <div class="card-value" id="pendingPayouts">â‚¹0</div>
                            </div>
                            <div class="card-icon">â³</div>
                        </div>
                        <div class="card-sub">From pending bookings</div>
                    </div>
                    <div class="dashboard-card card-purple">
                        <div class="card-top">
                            <div>
                                <div class="card-label">Total Rentals</div>
                                <div class="card-value" id="totalRentals">0</div>
                            </div>
                            <div class="card-icon">ğŸ”‘</div>
                        </div>
                    </div>
                </div>

                <!-- Earnings by Bike -->
                <div class="dashboard-table-wrap">
                    <div class="table-head">
                        <h2>Earnings by Bike</h2>
                    </div>
                    <div class="table-overflow">
                        <div id="bikeEarningsTable"></div>
                    </div>
                </div>

                <!-- Transaction History -->
                <div class="dashboard-table-wrap">
                    <div class="table-head">
                        <h2>Transaction History</h2>
                    </div>
                    <div class="table-overflow">
                        <div id="transactionsTable"></div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/bookings.js"></script>
    <script>
        if (!AuthService.isAuthenticated()) window.location.href = '../login.html';
        const currentUser = AuthService.getCurrentUser();
        if (currentUser && currentUser.role !== 'vendor') { alert('Access denied.'); window.location.href = '../index.html'; }
        if (currentUser) {
            document.getElementById('vendorName').textContent = `${currentUser.firstName || ''} ${currentUser.lastName || ''}`.trim() || 'Vendor';
            document.getElementById('avatarInitials').textContent = ((currentUser.firstName || 'V')[0] + (currentUser.lastName || '')[0]).toUpperCase();
        }

        const sidebar = document.getElementById('sidebar');
        document.getElementById('sidebarToggle').addEventListener('click', () => { sidebar.classList.toggle('open'); document.getElementById('sidebarOverlay').classList.toggle('show'); });
        document.getElementById('sidebarOverlay').addEventListener('click', () => { sidebar.classList.remove('open'); document.getElementById('sidebarOverlay').classList.remove('show'); });

        const vendorId = currentUser ? currentUser.id : 'V1';

        function loadEarnings() {
            const allBookings = JSON.parse(localStorage.getItem('ridego_bookings') || '[]');
            const mine = allBookings.filter(b => b.vendorId === vendorId);
            const completed = mine.filter(b => b.paymentStatus === 'completed');
            const pendingPay = mine.filter(b => b.paymentStatus !== 'completed' && b.status !== 'cancelled');

            const totalEarnings = completed.reduce((s, b) => s + (b.total || 0), 0);
            const pendingTotal = pendingPay.reduce((s, b) => s + (b.total || 0), 0);

            // This month
            const now = new Date();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthEarnings = completed.filter(b => new Date(b.createdAt) >= monthStart).reduce((s, b) => s + (b.total || 0), 0);

            document.getElementById('totalEarnings').textContent = `â‚¹${totalEarnings.toLocaleString()}`;
            document.getElementById('monthEarnings').textContent = `â‚¹${monthEarnings.toLocaleString()}`;
            document.getElementById('pendingPayouts').textContent = `â‚¹${pendingTotal.toLocaleString()}`;
            document.getElementById('totalRentals').textContent = completed.length;

            // Earnings by bike
            const bikeMap = {};
            completed.forEach(b => {
                if (!bikeMap[b.bikeName]) bikeMap[b.bikeName] = { count: 0, total: 0 };
                bikeMap[b.bikeName].count++;
                bikeMap[b.bikeName].total += (b.total || 0);
            });

            const bikeContainer = document.getElementById('bikeEarningsTable');
            const bikeNames = Object.keys(bikeMap);
            if (bikeNames.length === 0) {
                bikeContainer.innerHTML = '<div class="table-empty"><div class="empty-icon">ğŸï¸</div><p>No earnings data yet.</p></div>';
            } else {
                let html = `<table class="dashboard-table"><thead><tr><th>Bike</th><th>Rentals</th><th>Revenue</th></tr></thead><tbody>`;
                bikeNames.sort((a, b) => bikeMap[b].total - bikeMap[a].total).forEach(name => {
                    html += `<tr><td><strong>${name}</strong></td><td>${bikeMap[name].count}</td><td>â‚¹${bikeMap[name].total.toLocaleString()}</td></tr>`;
                });
                html += '</tbody></table>';
                bikeContainer.innerHTML = html;
            }

            // Transactions
            const txContainer = document.getElementById('transactionsTable');
            const allTx = [...completed, ...pendingPay].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            if (allTx.length === 0) {
                txContainer.innerHTML = '<div class="table-empty"><div class="empty-icon">ğŸ’³</div><p>No transactions yet.</p></div>';
            } else {
                let html = `<table class="dashboard-table"><thead><tr><th>Date</th><th>Booking ID</th><th>Customer</th><th>Bike</th><th>Amount</th><th>Status</th></tr></thead><tbody>`;
                allTx.forEach(b => {
                    const isPaid = b.paymentStatus === 'completed';
                    html += `<tr>
                        <td>${new Date(b.createdAt).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' })}</td>
                        <td><strong>${b.id}</strong></td>
                        <td>${b.userName}</td>
                        <td>${b.bikeName}</td>
                        <td>â‚¹${(b.total || 0).toLocaleString()}</td>
                        <td><span class="status-badge ${isPaid ? 'status-approved' : 'status-pending'}">${isPaid ? 'Received' : 'Pending'}</span></td>
                    </tr>`;
                });
                html += '</tbody></table>';
                txContainer.innerHTML = html;
            }
        }

        document.getElementById('logoutLink').addEventListener('click', e => { e.preventDefault(); if (confirm('Logout?')) { AuthService.logout(); window.location.href = '../login.html'; } });

        loadEarnings();
    </script>
</body>

</html>